version: '3.8'

services:
  backend:
    image: ${AZURE_REGISTRY_URL}/backend:latest
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - CORS_ORIGIN=${CORS_ORIGIN}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - BackendHost=${BackendHost}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PingBotDuration=${PingBotDuration:-300000}
      - MemoryLimitForOutputFileInBytes=${MemoryLimitForOutputFileInBytes:-31457280}
      - Server=${Server:-production}
      - JUDGE0_API_URL=${JUDGE0_API_URL}
    volumes:
      - backend-data:/app/public/TemporaryCodeBase
    depends_on:
      - mongo
      - judge0-server
    networks:
      - app-network

  frontend:
    image: ${AZURE_REGISTRY_URL}/frontend:latest
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_SERVER_URL=${REACT_APP_SERVER_URL}
      - REACT_APP_SERVER_WS_URL=${REACT_APP_SERVER_WS_URL}
    depends_on:
      - backend
    networks:
      - app-network

  mongo:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DB_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${DB_PASSWORD}
    volumes:
      - mongo-data:/data/db
    networks:
      - app-network

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=judge0
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0pass}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${JUDGE0_DB_USER:-judge0}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  judge0-server:
    image: judge0/judge0:latest
    ports:
      - "2358:2358"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0pass}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2358/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  judge0-worker:
    image: judge0/judge0:latest
    command: /bin/sh -c "cd / && java -jar judge0-api.jar"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=${JUDGE0_DB_USER:-judge0}
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0pass}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JUDGE0_WORKER=true
      - JUDGE0_WORKERS=1
    depends_on:
      - judge0-server
      - postgres
      - redis
    networks:
      - app-network

volumes:
  mongo-data:
  postgres-data:
  backend-data:

networks:
  app-network:
    driver: bridge
